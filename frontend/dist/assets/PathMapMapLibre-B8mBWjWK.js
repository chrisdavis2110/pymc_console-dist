import{r as e,j as t,bw as o,bx as r,by as n,bz as a,bA as i,aB as s,m as l,a7 as d}from"./vendor-react-DWFolw7W.js";import"./maplibre-gl-Bk5DsYkB.js";import{c}from"./recharts-BfwfJFmd.js";import{u,B as p}from"./BasemapLayer-CVTB3HoG.js";import{h as m,s as h,p as g}from"./useThemeColors-BvpMB3J1.js";import{B as x}from"./index-Bqom4285.js";import"./vendor-core-WoOfkQwm.js";import"./deckgl-DTsmDcfs.js";const f={version:8,sources:{},layers:[],glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf"},b={nodeColor:"#4338CA",localColor:"#4F46E5",hubColor:"#6366F1",edgeColor:"#3B3F4A",ambiguousColor:"#F9D26F",highlightColor:"#B49DFF",sourceColor:"#39D98A",destinationColor:"#B49DFF"};function y(e,t){if(!e)return t;if(e.startsWith("#"))return e;const o=g(e);return o?`#${o.r.toString(16).padStart(2,"0")}${o.g.toString(16).padStart(2,"0")}${o.b.toString(16).padStart(2,"0")}`:t}function C(){if("undefined"==typeof document)return b;const e=document.documentElement,t=getComputedStyle(e);return{nodeColor:y(t.getPropertyValue("--map-node-stroke").trim(),b.nodeColor),localColor:y(t.getPropertyValue("--map-local-color").trim(),b.localColor),hubColor:y(t.getPropertyValue("--map-hub-color").trim(),b.hubColor),edgeColor:y(t.getPropertyValue("--map-edge-rest").trim(),b.edgeColor),ambiguousColor:y(t.getPropertyValue("--accent-secondary").trim(),b.ambiguousColor),highlightColor:y(t.getPropertyValue("--accent-primary").trim(),b.highlightColor),sourceColor:y(t.getPropertyValue("--accent-success").trim(),b.sourceColor),destinationColor:y(t.getPropertyValue("--accent-primary").trim(),b.destinationColor)}}function v({prefix:o,isLocal:r,isSource:n,isDestination:a,isHighlighted:i,isAnimating:u,candidate:p,onHover:m,onLeave:h,onClick:g}){const f=s(),[b,y]=e.useState(!1);e.useEffect(()=>{u&&f.start({boxShadow:["0 0 0 0px rgba(113, 156, 223, 0)","0 0 0 2px rgba(113, 156, 223, 0.5)","0 0 0 2px rgba(113, 156, 223, 0.5)","0 0 0 0px rgba(113, 156, 223, 0)"],transition:{duration:.5,times:[0,.2,.7,1],ease:"easeInOut"}})},[u,f]);const C=e.useCallback(()=>{y(!0),m()},[m]),v=e.useCallback(()=>{y(!1),h()},[h]);return t.jsx(l.div,{className:c("flex items-center cursor-pointer","transition-all duration-150",i&&"ring-2 ring-accent-primary/50 rounded"),animate:f,initial:{boxShadow:"0 0 0 0px rgba(113, 156, 223, 0)"},onMouseEnter:C,onMouseLeave:v,onClick:g,style:{pointerEvents:"auto"},children:t.jsxs(x,{color:r?"amber":n?"green":a?"purple":"zinc",filled:!0,className:"font-mono text-[10px] shadow-lg border border-current/30",children:[r&&t.jsx(d,{className:"w-2.5 h-2.5 mr-1"}),o,b&&p.name&&t.jsx("span",{className:"ml-1 opacity-75",children:p.name})]})})}function j({resolvedPath:s,localNode:l,hubNodes:d=[],hoveredHopIndex:c,onHoverHop:g,traceSnr:x}){const b=void 0!==x&&x.length>0,y=e.useRef(null),j=u(),k=e.useMemo(()=>new Set(d),[d]),[S,N]=e.useState(null),[F,L]=e.useState(!1),[w,P]=e.useState(0);e.useEffect(()=>{var e;const t=null==(e=y.current)?void 0:e.getMap();if(!t)return;const o=t.getCanvas();if(!o)return;const r=e=>{e.preventDefault()},n=()=>{P(e=>e+1)};return o.addEventListener("webglcontextlost",r),o.addEventListener("webglcontextrestored",n),()=>{o.removeEventListener("webglcontextlost",r),o.removeEventListener("webglcontextrestored",n)}},[w]);const{positions:D,markers:E,pathLineGeoJSON:H,edges:M}=e.useMemo(()=>{const e=[],t=[],o=[],r=[];let n=0;s.hops.forEach((a,i)=>{const s=a.candidates.filter(e=>{return t=e.latitude,o=e.longitude,0!==t||0!==o;var t,o});if(0===s.length)return;const l=[...s].sort((e,t)=>t.probability-e.probability)[0],d=[l.longitude,l.latitude];if(o.push(d),o.length>=2){const e=o[o.length-2],t=o.length-2,n=null==x?void 0:x[t],a=d[0]-e[0],i=d[1]-e[1],s=Math.atan2(a,i)*(180/Math.PI);r.push({from:e,to:d,snrFwd:n,midpoint:[(e[0]+d[0])/2,(e[1]+d[1])/2],bearing:s})}const c=!0===a.isSource,u=!0===a.isDestination;s.forEach((o,r)=>{const l=[o.latitude,o.longitude];e.push(l);const d=0===r;t.push({position:l,prefix:a.prefix,confidence:a.confidence,candidateCount:s.length,hopIndex:i,candidate:o,isHub:k.has(o.hash),isPrimary:d,isSource:c,isDestination:u,validIndex:n})}),n++});const a={type:"FeatureCollection",features:o.length>=2?[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:o}}]:[]};return{positions:e,markers:t,pathLineGeoJSON:a,edges:r}},[s,k,x]),A=e.useMemo(()=>{if(0===D.length)return null;let e=1/0,t=-1/0,o=1/0,r=-1/0;for(const[n,a]of D)n<e&&(e=n),n>t&&(t=n),a<o&&(o=a),a>r&&(r=a);return[[o,e],[r,t]]},[D]),B=e.useMemo(()=>{if(0===D.length)return l?[l.longitude,l.latitude]:[0,0];let e=0,t=0;for(const[o,r]of D)e+=o,t+=r;return[t/D.length,e/D.length]},[D,l]),V=e.useCallback(()=>{var e;const t=null==(e=y.current)?void 0:e.getMap();t&&A?(t.fitBounds(A,{padding:{top:50,bottom:50,left:50,right:50},maxZoom:15,duration:0}),requestAnimationFrame(()=>{L(!0)})):L(!0)},[A]),I=e.useCallback(e=>{N({longitude:e.position[1],latitude:e.position[0],marker:e})},[]);return 0===D.length?t.jsx("div",{className:"h-full flex items-center justify-center text-text-muted text-sm bg-bg-elevated",children:"No mappable path data"}):t.jsx("div",{className:"h-full w-full transition-opacity duration-300 ease-out",style:{opacity:F?1:0},children:t.jsxs(o,{ref:y,initialViewState:{longitude:B[0],latitude:B[1],zoom:10},onLoad:V,style:{height:"100%",width:"100%"},mapStyle:f,attributionControl:!1,children:[t.jsx(p,{mode:j}),b?M.map((e,o)=>{const a=void 0!==e.snrFwd?m()[h(e.snrFwd)]||"#6b7280":"#71717a",i={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[e.from,e.to]}}]};return t.jsx(r,{id:`edge-${o}`,type:"geojson",data:i,children:t.jsx(n,{id:`edge-line-${o}`,type:"line",paint:{"line-color":a,"line-width":3,"line-opacity":.9},layout:{"line-cap":"round","line-join":"round"}})},`edge-${o}`)}):H.features.length>0&&t.jsx(r,{id:"path-line-source",type:"geojson",data:H,children:t.jsx(n,{id:"path-line",type:"line",paint:{"line-color":C().edgeColor,"line-width":2,"line-opacity":.7},layout:{"line-cap":"round","line-join":"round"}})}),E.filter(e=>e.isPrimary).map(e=>{const o=c===e.hopIndex;return t.jsx(a,{longitude:e.position[1],latitude:e.position[0],anchor:"center",children:t.jsx(v,{prefix:e.prefix,isLocal:e.candidate.isLocal||!1,isSource:e.isSource,isDestination:e.isDestination,isHighlighted:o,isAnimating:!1,candidate:e.candidate,onHover:()=>null==g?void 0:g(e.hopIndex),onLeave:()=>null==g?void 0:g(null),onClick:()=>I(e)})},`${e.hopIndex}-${e.candidate.hash}`)}),S&&t.jsx(i,{longitude:S.longitude,latitude:S.latitude,anchor:"bottom",offset:[0,-12],closeOnClick:!1,onClose:()=>N(null),className:"maplibre-popup",children:t.jsxs("div",{className:"text-xs",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"font-semibold",children:S.marker.candidate.name}),(()=>{const e=C();return t.jsxs(t.Fragment,{children:[S.marker.isSource&&t.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.sourceColor,color:"#000"},children:"SRC"}),S.marker.isDestination&&t.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.destinationColor,color:"#000"},children:"DST"}),S.marker.isHub&&t.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.hubColor,color:"#000"},children:"HUB"}),S.marker.candidate.isLocal&&t.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.localColor,color:"#fff"},children:"LOCAL"})]})})()]}),t.jsxs("div",{className:"text-text-muted font-mono text-[10px]",children:[S.marker.prefix," â€¢ ",S.marker.candidate.hash.slice(0,10),"..."]}),!S.marker.isPrimary&&S.marker.candidateCount>1&&t.jsxs("div",{style:{color:C().ambiguousColor},children:["Alternative (",(100*S.marker.candidate.probability).toFixed(0),"%)"]}),S.marker.isPrimary&&S.marker.candidateCount>1&&t.jsxs("div",{className:"text-text-muted",children:[S.marker.candidateCount," candidates"]})]})})]},w)})}export{j as default};
