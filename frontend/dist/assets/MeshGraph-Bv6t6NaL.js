import{r as e,j as t,p as s,q as a}from"./vendor-react-54o2BuWt.js";import{c as n,r,b0 as i,v as l,b1 as o,u as c,b2 as d,f as u,aL as m,aY as x,T as h,b3 as p,b4 as g,A as f,m as b,X as y,R as v,b5 as j,B as w,G as C}from"./index-jS7dHlo8.js";import{D as k,M as N,a as S}from"./DeepAnalysisModal-BDuIucax.js";import{D as M}from"./DataBox-Do_Cl-e9.js";import{L}from"./loader-circle-2FAV_tMF.js";import{S as F,T as E}from"./target-CJG2sRfp.js";import{C as D,Z as P}from"./zap-DMp3tbuD.js";import{G as H}from"./git-branch-pUPraoxp.js";import{H as B}from"./house-DzVJWsxe.js";import{N as z}from"./network--tY38d6c.js";import"./deckgl-DTsmDcfs.js";import"./vendor-core-dnrJb0w-.js";const R=n("circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),I=n("focus",[["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]),$=n("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]]);function G(t,s=1e3){const[a,n]=e.useState(t),r=e.useRef(Date.now()),i=e.useRef(null);return e.useEffect(()=>{const e=Date.now(),a=s-(e-r.current);return a<=0?(n(t),r.current=e):(i.current&&clearTimeout(i.current),i.current=setTimeout(()=>{n(t),r.current=Date.now()},a)),()=>{i.current&&clearTimeout(i.current)}},[t,s]),a}const T=Math.PI/180;function A(e,t){if(e<=0)return 0;const s=t-e;if(s>1209600)return 0;if(s<0)return 1;const a=s/3600;return Math.exp(-a/12)}const Z={spaceSize:4096,simulationRepulsion:1.5,simulationLinkDistance:30,simulationGravity:.15,simulationCenter:.5,simulationFriction:.85,simulationDecay:800,simulationLinkSpring:.5,simulationClusterStrength:.4,simulationRepulsionTheta:1.2};function W(e,t,s,a,n=3){const r=e<=0?0:Math.log10(e+1),i=Math.log10(5001),l=Math.min(1,r/i),o=6+18*Math.pow(l,n);if(a)return o;const c=s-t;return c>=K?Math.max(6,.5*o):c>=q?Math.max(6,.7*o):o}const _={local:"#FFFFFF",hub:"#E0E0E0",gateway:"#C8C8C8",backbone:"#B0B0B0",neighbor:"#F0F0F0",mobile:"#A0A0A0",ghost:"#505050",standard:"#808080"},O={local:"Local Node",hub:"Hub (≥10% traffic)",gateway:"Gateway (7-10%)",backbone:"Backbone",neighbor:"Direct RF Neighbor",mobile:"Mobile/Volatile",ghost:"Discovered (unconfirmed)",standard:"Standard Node"},V={local:B,hub:P,gateway:H,backbone:H,neighbor:v,mobile:$,ghost:D,standard:R},q=432e3,K=864e3;function Y(e,t,s,a,n={x:0,y:0}){const r=e*T,i=s*T,l=(t-a)*T,o=(e-s)*T,c=637100;return n.x=l*Math.cos(.5*(r+i))*c,n.y=o*c,n}const J={background:`linear-gradient(to right, ${["#2A2A2A","#3D3D3D","#505050","#636363","#767676","#898989","#9C9C9C","#AFAFAF","#C2C2C2","#D5D5D5","#E8E8E8","#F5F5F5","#FFFFFF"].join(", ")})`},U=e.memo(function({nodeCount:e,edgeCount:s}){return t.jsxs("div",{className:"absolute top-4 right-4 z-10 bg-bg-elevated/95 rounded-lg border border-border-subtle shadow-xl min-w-[180px] type-data-xs",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-border-subtle/50",children:[t.jsx("span",{className:"font-medium text-text-primary",children:"Topology"}),t.jsxs("span",{className:"text-text-muted tabular-nums",children:[e,"n · ",s,"e"]})]}),t.jsxs("div",{className:"px-3 py-2",children:[t.jsx("div",{className:"text-text-muted text-[10px] mb-1",children:"Packet count"}),t.jsx("div",{className:"h-1 rounded-sm",style:J}),t.jsxs("div",{className:"flex justify-between text-[10px] text-text-muted mt-0.5",children:[t.jsx("span",{children:"0"}),t.jsx("span",{children:"10K+"})]}),t.jsxs("div",{className:"flex items-center gap-1.5 mt-2 pt-2 border-t border-border-subtle/30",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-accent-primary"}),t.jsx("span",{className:"text-[10px] text-text-muted",children:"p99 outlier"})]})]})]})}),X="▁▂▃▄▅▆▇█",Q=[-5,0,4,7],ee=[-115,-105,-95,-80],te=["text-signal-critical","text-signal-poor","text-accent-secondary","text-accent-secondary","text-accent-success"],se=["text-signal-critical","text-signal-poor","text-accent-secondary","text-accent-success","text-accent-success"],ae=["░░░░","▂░░░","▂▃░░","▂▄▅░","▂▄▆█"],ne={active:{color:"green",label:"Active"},recent:{color:"yellow",label:"Recent"},stale:{color:"orange",label:"Stale"},inactive:{color:"zinc",label:"Offline"}},re=(e,t,s=6)=>{const a=t?Math.min(1,e/t):0,n=Math.floor(a*s),r=Math.floor(8*(a*s-n));return X[7].repeat(n)+(n<s&&r?X[r-1]:"")+" ".repeat(Math.max(0,s-n-(r?1:0)))},ie=(e,t=10)=>"●".repeat(Math.round(e*t))+"○".repeat(t-Math.round(e*t)),le=(e,t)=>{const s=t?te:se,a=(t?Q:ee).findIndex(t=>e<t);return[ae[a<0?4:a],s[a<0?4:a]]},oe=e.memo(function({c:e,maxPkts:s}){const[a,n]=(e=>e.isZeroHop?["◉","text-yellow-400"]:e.isDirectPath?["→","text-cyan-400"]:e.isLoopEdge?["↺","text-purple-400"]:["─","text-text-muted"])(e);return t.jsxs("li",{className:"flex items-center gap-1.5 py-0.5 px-1 rounded hover:bg-subtle-fill/30 transition-colors",children:[t.jsx("span",{className:`w-3 text-center shrink-0 ${n}`,children:a}),t.jsx("span",{className:"size-1.5 shrink-0 rounded-full",style:{backgroundColor:_[e.nodeClass]}}),t.jsx("code",{className:"shrink-0 text-text-primary",children:e.prefix}),t.jsx("span",{className:"flex-1 min-w-0 truncate text-text-muted",children:e.name||""}),t.jsx("span",{className:"text-accent-secondary tracking-tighter shrink-0",children:re(e.packetCount,s,4)}),t.jsx("span",{className:"tabular-nums text-text-secondary shrink-0 w-8 text-right",children:e.packetCount>=1e3?`${(e.packetCount/1e3).toFixed(1)}k`:e.packetCount})]})}),ce=e.memo(function({node:s,connections:a,onClose:n}){const r=e.useMemo(()=>Math.max(s.packetCount,...a.map(e=>e.packetCount),1),[s.packetCount,a]),i=e.useMemo(()=>[...a].sort((e,t)=>e.isZeroHop!==t.isZeroHop?e.isZeroHop?-1:1:e.isDirectPath!==t.isDirectPath?e.isDirectPath?-1:1:t.packetCount-e.packetCount),[a]),l=ne[s.activityLevel]??{color:"zinc",label:s.activityLevel};return t.jsxs(b.div,{variants:j,initial:"hidden",animate:"visible",exit:"exit",className:"absolute inset-x-4 bottom-4 z-20 bg-bg-elevated/95 rounded-xl border border-border-subtle shadow-xl",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border-subtle/50",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("span",{className:"size-2 shrink-0 rounded-full",style:{backgroundColor:_[s.nodeClass]}}),t.jsx("code",{className:"text-sm font-semibold text-text-primary shrink-0",children:s.prefix}),s.name&&t.jsx("span",{className:"text-sm text-text-secondary truncate",children:s.name}),t.jsxs("div",{className:"flex gap-1 shrink-0",children:[s.isLocal&&t.jsx(w,{color:"yellow",compact:!0,children:"LOCAL"}),s.isHub&&t.jsx(w,{color:"indigo",compact:!0,children:"HUB"}),s.isGateway&&t.jsx(w,{color:"violet",compact:!0,children:"GW"}),s.isBackbone&&t.jsx(w,{color:"emerald",compact:!0,children:"BONE"}),s.isMobile&&t.jsx(w,{color:"orange",compact:!0,children:"MOB"}),s.isZeroHop&&t.jsx(w,{color:"amber",compact:!0,children:"RF"})]})]}),t.jsx(C,{plain:!0,onClick:n,title:"Close",className:"shrink-0",children:t.jsx(y,{className:"size-4"})})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-3 font-mono text-[11px]",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx(w,{color:l.color,compact:!0,children:l.label}),t.jsx("span",{className:"text-text-muted",children:"•"}),t.jsx("span",{className:"text-text-secondary",children:O[s.nodeClass]}),s.hasGeo&&t.jsx(w,{color:"cyan",compact:!0,children:"GPS"}),s.hasCollision&&t.jsx(w,{color:"red",compact:!0,children:"⚠ COLLISION"})]}),t.jsx(M,{copy:!0,size:"compact",truncate:[10,6],className:"w-full",children:s.hash}),t.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"Packets"}),t.jsx("div",{className:"text-text-primary tabular-nums",children:s.packetCount.toLocaleString()}),t.jsx("div",{className:"text-accent-primary tracking-tighter",children:re(s.packetCount,r,6)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"Degree"}),t.jsx("div",{className:"text-text-primary tabular-nums",children:s.degree}),t.jsx("div",{className:"text-accent-secondary tracking-tighter",children:re(s.degree,Math.max(s.degree,10),6)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"Central"}),t.jsxs("div",{className:"text-text-primary tabular-nums",children:[(100*s.betweenness).toFixed(0),"%"]}),t.jsx("div",{className:"text-accent-primary tracking-tighter",children:ie(s.betweenness,6)})]})]}),s.isZeroHop&&(null!==s.avgRssi||null!==s.avgSnr)&&t.jsxs("div",{className:"flex gap-4 pt-2 border-t border-border-subtle/30",children:[null!==s.avgRssi&&(()=>{const[e,a]=le(s.avgRssi,!1);return t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"RSSI"}),t.jsxs("div",{className:"flex items-baseline gap-1",children:[t.jsx("span",{className:`${a} tracking-tight`,children:e}),t.jsx("span",{className:"tabular-nums text-text-secondary",children:s.avgRssi.toFixed(0)}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"dBm"})]})]})})(),null!==s.avgSnr&&(()=>{const[e,a]=le(s.avgSnr,!0);return t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"SNR"}),t.jsxs("div",{className:"flex items-baseline gap-1",children:[t.jsx("span",{className:`${a} tracking-tight`,children:e}),t.jsx("span",{className:"tabular-nums text-text-secondary",children:s.avgSnr.toFixed(1)}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"dB"})]})]})})()]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-[9px] text-text-muted uppercase",children:"Connections"}),t.jsx(w,{color:"zinc",compact:!0,children:a.length})]}),i.length>0?t.jsxs("ul",{className:"max-h-32 overflow-y-auto space-y-0.5 scrollbar-thin",children:[i.slice(0,20).map(e=>t.jsx(oe,{c:e,maxPkts:r},e.hash)),i.length>20&&t.jsxs("li",{className:"text-center text-text-muted py-1",children:["+",i.length-20," more"]})]}):t.jsx("p",{className:"text-text-muted italic",children:"No connections"})]}),t.jsxs("div",{className:"hidden lg:flex lg:flex-col lg:gap-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Cluster"}),t.jsxs("span",{className:"text-text-secondary",children:["#",s.communityId]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Edges"}),t.jsx("span",{className:"text-text-secondary",children:s.edgeCount})]}),s.hasCollision&&t.jsxs("div",{className:"flex justify-between col-span-2",children:[t.jsx("span",{className:"text-signal-poor",children:"Prefix Conf."}),t.jsxs("span",{className:"text-signal-poor tabular-nums",children:[(100*s.prefixConfidence).toFixed(0),"%"]})]})]}),t.jsxs("div",{className:"mt-auto pt-2 border-t border-border-subtle/30",children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase mb-1.5",children:"Edge Types"}),t.jsxs("div",{className:"grid grid-cols-3 gap-1 text-[10px]",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-yellow-400",children:"◉"}),t.jsx("span",{className:"text-text-muted",children:"RF"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-cyan-400",children:"→"}),t.jsx("span",{className:"text-text-muted",children:"Direct"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-purple-400",children:"↺"}),t.jsx("span",{className:"text-text-muted",children:"Loop"})]})]})]})]})]})]})});function de(){return t.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 text-center px-8",children:[t.jsx("div",{className:"p-4 rounded-full bg-subtle-fill",children:t.jsx(z,{className:"w-8 h-8 text-text-muted"})}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h2",{className:"text-lg font-medium text-text-primary",children:"No Topology Data"}),t.jsx("p",{className:"text-sm text-text-muted max-w-sm",children:"The mesh topology will appear here once packets are received and processed. This typically takes a few minutes after starting."})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-text-muted mt-2",children:[t.jsx(v,{className:"w-4 h-4 animate-pulse"}),t.jsx("span",{children:"Waiting for mesh traffic..."})]})]})}function ue(){var n;const v=r(),[j,w]=e.useState(!1),C=i(),M=l(),[D,P]=e.useState(!1),[H,B]=e.useState("fetching"),[z,R]=e.useState(0),$=e.useRef(!1);e.useEffect(()=>{v&&!$.current&&($.current=!0,(async()=>{P(!0),B("fetching"),R(0),await C(),B("analyzing"),await new Promise(e=>setTimeout(e,200)),B("building");const e=Date.now(),t=Date.now()-e;t<600&&await new Promise(e=>setTimeout(e,600-t)),B("discovering"),await new Promise(e=>setTimeout(e,400)),B("complete"),await new Promise(e=>setTimeout(e,800)),P(!1),w(!0)})())},[v,C]),e.useEffect(()=>{"fetching"===H&&(M.loadProgress?R(M.loadProgress.loaded):M.packetCount>0&&R(M.packetCount))},[H,M.loadProgress,M.packetCount]);const T=o(),O=c(),q=G(d(),2e3),K=u(),J=m(),[X,Q]=e.useState(!0),[ee,te]=e.useState(null),se=e.useRef(void 0),[ae,ne]=e.useState(""),[re,ie]=e.useState(!1),le=e.useRef(null),[oe]=e.useState(1),[ue]=e.useState(.15),[me]=e.useState(2.75),[xe]=e.useState(3),he=G(me,300),pe=G(xe,300),ge=e.useRef(oe),fe=e.useRef(ue);e.useEffect(()=>{ge.current=oe},[oe]),e.useEffect(()=>{fe.current=ue},[ue]);const be=e.useRef({node:null,x:0,y:0}),ye=e.useRef(null),[ve,je]=e.useState(!1),[we]=e.useState(!1),[Ce,ke]=e.useState(!1),[Ne,Se]=e.useState(Date.now()),[,Me]=e.useState(Date.now()),[Le,Fe]=e.useState(Date.now());e.useEffect(()=>{if(O.length>0){const e=1e3*(O[0].timestamp??0),t=1e3*(O[O.length-1].timestamp??0);Me(e),Fe(t),Ce||we||Se(t)}},[O.length,we,Ce]),e.useEffect(()=>{let e;return Ce&&we&&(e=setInterval(()=>{Se(e=>{const t=e+5e3;return t>=Le?(ke(!1),Le):t})},50)),()=>clearInterval(e)},[Ce,we,Le]);const Ee=e.useMemo(()=>{if(!we||0===O.length)return null;const e=Ne-9e5,t=O.filter(t=>{const s=1e3*(t.timestamp??0);return s>=e&&s<=Ne});return{packets:t,count:t.length,windowStart:e,windowEnd:Ne}},[we,O,Ne]);e.useEffect(()=>{const e=e=>{var t,s;if(!(e.target instanceof HTMLInputElement))switch(e.key.toLowerCase()){case"f":e.metaKey||e.ctrlKey||(e.preventDefault(),null==(t=Je.current)||t.fitView(800));break;case"escape":re?(ie(!1),ne("")):ee&&(se.current=void 0,te(null),null==(s=Je.current)||s.unselectAllPoints());break;case"/":re||(e.preventDefault(),ie(!0),setTimeout(()=>{var e;return null==(e=le.current)?void 0:e.focus()},50));break;case" ":e.preventDefault();{const e=Je.current;e&&(X?e.pause():e.start(),Q(e=>!e))}}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[re,ee,X]);const De=(null==J?void 0:J.latitude)??0,Pe=(null==J?void 0:J.longitude)??0,He=null!==J,[Be,ze]=e.useState(Math.floor(Date.now()/1e3));e.useEffect(()=>{const e=setInterval(()=>{ze(Math.floor(Date.now()/1e3))},6e4);return()=>clearInterval(e)},[]);const Re=e.useMemo(()=>{var e;if(!q||0===q.size||!j)return[];const t=[],s=(null==K?void 0:K.node_name)??(null==(e=null==K?void 0:K.config)?void 0:e.node_name)??null,a={x:0,y:0},n=[];for(const i of q.values())i.isLocal||n.push(i.packetCount);n.sort((e,t)=>e-t);const r=n[Math.floor(.99*n.length)]??n[n.length-1]??1/0;for(const i of q.values()){const e=i.isLocal?1:A(i.lastSeen,Be);if(0===e&&!i.isLocal)continue;const n=i.packetCount>0?Math.log10(i.packetCount+1):0,l=Math.log10(5001),o=Math.min(1,n/l),c=!i.isLocal&&i.packetCount>=r;let d;d=i.isLocal?4:c?5:o<.2?0:o<.4?1:o<.6?2:o<.8?3:4;const u="#FFFFFF",m=W(i.packetCount,i.lastSeen,Be,i.isLocal,me),x=i.isLocal?s??i.name:i.name;let h,p,g=!1;He&&(i.isLocal?(h=0,p=0,g=!0):i.latitude&&i.longitude&&(Y(i.latitude,i.longitude,De,Pe,a),h=a.x,p=a.y,g=!0)),t.push({id:i.hash,label:x?`${i.prefix} ${x}`:i.prefix,color:u,trafficCategory:d,size:m,x:h,y:p,recencyWeight:e,nodeClass:i.nodeClass,name:x,prefix:i.prefix,packetCount:i.packetCount,betweenness:i.betweenness,communityId:i.communityId,isLocal:i.isLocal,isHub:i.isHub,isGateway:i.isGateway,isBackbone:i.isBackbone,isMobile:i.isMobile,isGhost:i.isGhost,isInLoop:i.isInLoop,isZeroHop:i.isZeroHop,hasGeo:g,avgRssi:i.avgRssi,avgSnr:i.avgSnr,degree:i.degree,activityLevel:i.activityLevel,prefixConfidence:i.prefixConfidence,hasCollision:i.hasCollision,lastSeen:i.lastSeen})}return t},[q,j,He,De,Pe,null==K?void 0:K.node_name,null==(n=null==K?void 0:K.config)?void 0:n.node_name,Be,me]),Ie=e.useMemo(()=>{const e=new Set;for(const t of Re)e.add(t.id);return e},[Re]),{rawLinks:$e}=e.useMemo(()=>{const e=(null==T?void 0:T.edges)??[];if(!e||0===e.length||!j)return{rawLinks:[],maxCertainCount:0,hasZeroHopEdges:!1,hasLoopEdges:!1,hasDirectPathEdges:!1};const t=[];let s=!1,a=!1,n=!1;for(const d of e)Ie.has(d.fromHash)&&Ie.has(d.toHash)&&(t.push(d.certainCount),s=s||!0===d.isZeroHop,a=a||!0===d.isLoopEdge,n=n||!0===d.isDirectPathEdge);t.sort((e,t)=>e-t);const r=t[Math.floor(.98*t.length)]??t[t.length-1]??1,i=Math.max(1,r),l=Math.log10(i+1),o=t[Math.floor(.99*t.length)]??t[t.length-1]??1/0,c=[];for(const d of e){if(!Ie.has(d.fromHash)||!Ie.has(d.toHash))continue;const e=d.avgRecency,t=e<0,s=d.certainCount>0?Math.log10(d.certainCount+1):0,a=Math.min(1,s/l),n=Math.pow(a,xe),r=Math.pow(a,ue),i=.1,u=5,m=1,x=2.95;let h=i+n*(u-Math.min(1,Math.max(0,(xe-.05)/x))*(u-m)-i);t&&(h=.1);const p=!t&&d.certainCount>=o;let g;if(t)g="#1E293B";else if(p){const e=getComputedStyle(document.documentElement).getPropertyValue("--accent-primary").trim();if(e.startsWith("color(display-p3")){const t=e.match(/color\(display-p3\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)/);if(t){const e=Math.round(255*parseFloat(t[1])),s=Math.round(255*parseFloat(t[2])),a=Math.round(255*parseFloat(t[3]));g=`#${e.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`}else g="#719CDF"}else if(e.startsWith("rgb")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t){const e=parseInt(t[1]),s=parseInt(t[2]),a=parseInt(t[3]);g=`#${e.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`}else g="#719CDF"}else g=e.startsWith("#")?e:"#719CDF"}else{const e=Math.round(80+144*r).toString(16).padStart(2,"0");g=`#${e}${e}${e}`}const f=null==q?void 0:q.get(d.fromHash),b=null==q?void 0:q.get(d.toHash),y=(null==f?void 0:f.isHub)||(null==f?void 0:f.isGateway)||(null==f?void 0:f.isBackbone)||(null==f?void 0:f.isLocal),v=(null==b?void 0:b.isHub)||(null==b?void 0:b.isGateway)||(null==b?void 0:b.isBackbone)||(null==b?void 0:b.isLocal);let j=0,w=300;t||(y&&v?(j=.8,w=250):y||v?(j=.4,w=50):(j=.1,w=300));const C=!t;let k;k=t?0:p?5:a<.25?1:a<.5?2:a<.75?3:4,c.push({source:d.fromHash,target:d.toHash,color:g,width:h,strength:j,distance:w,arrow:C,trafficCategory:k,recencyWeight:e,packetCount:d.packetCount,certainCount:d.certainCount,isZeroHop:d.isZeroHop??!1,isLoopEdge:d.isLoopEdge??!1,isDirectPath:d.isDirectPathEdge,avgConfidence:d.avgConfidence})}return{rawLinks:c,maxCertainCount:i,hasZeroHopEdges:s,hasLoopEdges:a,hasDirectPathEdges:n}},[null==T?void 0:T.validatedEdges,null==T?void 0:T.weakEdges,j,Ie,q,xe]),Ge=e.useMemo(()=>{const e=new Map;for(const t of $e)e.set(t.source,(e.get(t.source)??0)+1),e.set(t.target,(e.get(t.target)??0)+1);return e},[$e]),Te=e.useMemo(()=>{const e=new Map;for(const t of Re)e.set(t.id,t);return e},[Re]),Ae=e.useMemo(()=>{if(!ee)return[];const e=[],t=ee.hash;for(const s of $e){let a=null,n="bidirectional";if(s.source===t?(a=s.target,n="outbound"):s.target===t&&(a=s.source,n="inbound"),a){const t=Te.get(a);t&&e.push({hash:a,prefix:t.prefix,name:t.name,nodeClass:t.nodeClass,packetCount:s.packetCount,certainCount:s.certainCount,isZeroHop:s.isZeroHop,isDirectPath:s.isDirectPath,isLoopEdge:s.isLoopEdge,direction:n})}}return e},[ee,$e,Te]),Ze=e.useMemo(()=>{const e=new Map;for(const t of Re)e.set(t.label,t.trafficCategory),e.set(t.prefix,t.trafficCategory);return e},[Re]),We=e.useCallback(()=>{document.querySelectorAll(".css-label--label").forEach(e=>{var t;const s=(null==(t=e.textContent)?void 0:t.trim())??"",a=Ze.get(s);void 0!==a&&(e.classList.remove("meshgraph-label-cat-0","meshgraph-label-cat-1","meshgraph-label-cat-2","meshgraph-label-cat-3","meshgraph-label-cat-4","meshgraph-label-cat-5"),e.classList.add(`meshgraph-label-cat-${a}`))})},[Ze]),[_e,Oe]=e.useState(null),[Ve,qe]=e.useState(null),[Ke,Ye]=e.useState({}),Je=e.useRef(null),Ue=e.useRef(!1),Xe=e.useRef(!1),Qe=e.useRef(!1),et=e.useRef(""),[tt,st]=e.useState(!0);e.useEffect(()=>{if(0===Re.length)return Oe(null),qe(null),void(et.current="");const e=`${Re.length}-${$e.length}-${he.toFixed(2)}-${pe.toFixed(2)}`,t=et.current;if(t&&Xe.current){const[e,s]=t.split("-").map(Number),a=Math.abs(Re.length-e)/Math.max(e,1),n=Math.abs($e.length-s)/Math.max(s,1),r=!t.endsWith(`${he.toFixed(2)}-${pe.toFixed(2)}`);if(a<.05&&n<.05&&!r)return}let s=!1,n=null;return n=setTimeout(async()=>{if(!Ue.current){Ue.current=!0,Xe.current=!0,st(!0);try{const n=(e,t)=>"number"==typeof e&&Number.isFinite(e)?e:t,r=186,i=255,l=92,o=ge.current;let c;c=o<=1?i-o*(i-r):r-(o-1)*(r-l);const d=e=>{const t=Math.max(0,Math.min(255,Math.round(e))).toString(16).padStart(2,"0");return`#${t}${t}${t}`},u=e=>d(c+(i-c)*e),m=getComputedStyle(document.documentElement).getPropertyValue("--accent-primary").trim();let x;if(m.startsWith("color(display-p3")){const e=m.match(/color\(display-p3\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)/);if(e){const t=Math.round(255*parseFloat(e[1])),s=Math.round(255*parseFloat(e[2])),a=Math.round(255*parseFloat(e[3]));x=`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`}else x="#719CDF"}else x=m.startsWith("#")?m:"#719CDF";const h=document.documentElement;h.style.setProperty("--meshgraph-label-0",u(0)),h.style.setProperty("--meshgraph-label-1",u(.33)),h.style.setProperty("--meshgraph-label-2",u(.66)),h.style.setProperty("--meshgraph-label-3",u(1)),h.style.setProperty("--meshgraph-label-4","#FFFFFF"),h.style.setProperty("--meshgraph-label-5",x);const p=e=>e.isLocal?"Local":e.isHub?"Hub":e.isGateway?"Gateway":e.isBackbone?"Backbone":"Node",g=Re.sort((e,t)=>{const s=5===e.trafficCategory,a=5===t.trafficCategory;return s&&!a?1:!s&&a?-1:e.size-t.size}).map(e=>{let t;if(5===e.trafficCategory)t=x;else if(4===e.trafficCategory)t="#FFFFFF";else{const s=e.trafficCategory/3;t=u(s)}return{id:e.id,label:e.label,color:t,trafficCategory:e.trafficCategory,size:n(e.size,8),groupLabel:p(e)}}),f=[...$e].sort((e,t)=>(t.certainCount??t.packetCount??0)-(e.certainCount??e.packetCount??0)),b=Math.floor(1*f.length),y=new Set(f.slice(0,Math.max(b,10)).map(e=>`${e.source}-${e.target}`)),v=$e.filter(e=>y.has(`${e.source}-${e.target}`)).sort((e,t)=>{const s=5===e.trafficCategory,a=5===t.trafficCategory;return s&&!a?1:!s&&a?-1:e.width-t.width}).map(e=>({source:e.source,target:e.target,color:e.color,trafficCategory:e.trafficCategory,width:n(e.width,1),strength:1,distance:30}));let j=g,w=v;if(we&&Ee){const e=new Set;for(const t of Ee.packets){const s=t.src_hash||t.packet_hash;s&&e.add(s),t.dst_hash&&e.add(t.dst_hash);const a=t.original_path||[];Array.isArray(a)&&a.length>0&&(t.src_hash&&e.add(t.src_hash),t.dst_hash&&e.add(t.dst_hash))}j=g.map(t=>{const s=e.has(t.id);return{...t,trafficCategory:s?t.trafficCategory:0,size:s?t.size:2,label:s?t.label:""}}),w=v.map(t=>{const s=e.has(t.source),a=e.has(t.target),n=s&&a;return{...t,color:n?t.color:"#1E293B",trafficCategory:n?t.trafficCategory:0,width:n?Math.max(1,t.width):.1,strength:t.strength}})}const C=j.length>0,k=new Set(w.map(e=>e.width)),N=w.length>0,S=1===k.size?k.values().next().value:null,M=new Set(w.map(e=>e.strength)),L=w.length>=2&&M.size>=2,F=new Set(w.map(e=>e.distance)),E=w.length>=2&&F.size>=2,D=new Set(j.map(e=>e.groupLabel)).size>=2,P=(e=!1)=>({points:{pointIdBy:"id",pointColorBy:"color",pointColorStrategy:"direct",pointDefaultColor:"#FFFFFF",pointLabelBy:"label",pointGreyoutOpacity:.5,pointDefaultSize:8,pointSizeScale:1,...e?{}:{pointMass:e=>1+((e.size??8)-6)/18*10},...!e&&C?{pointSizeBy:"size",pointSizeStrategy:"direct"}:{},...!e&&D?{pointClusterBy:"groupLabel"}:{},...!e&&N?{linkWidthBy:"width",linkWidthStrategy:"direct"}:{},...!e&&L?{linkStrengthBy:"strength",linkStrengthStrategy:"direct"}:{}},links:{linkSourceBy:"source",linkTargetsBy:["target"],linkColorBy:"color",linkColorStrategy:"direct",linkDefaultWidth:null!==S?S:1,linkWidthScale:1,linkDefaultColor:"#505050",linkGreyoutOpacity:.15,...!e&&N?{linkWidthBy:"width",linkWidthStrategy:"direct"}:{},...!e&&E?{linkDistanceBy:"distance",linkDistanceStrategy:"direct"}:{}}});let H;try{H=await a(P(!1),j,w)}catch(t){H=await a(P(!0),j,w)}if(s||!H)return;const B=H.points??null,z=H.links??null,R=H.cosmographConfig;Oe(B),qe(z),Ye({...R,fitViewOnInit:!1,...Z}),rt.current=!1,et.current=e}catch(n){st(!1)}finally{Ue.current=!1}}},we?50:500),()=>{s=!0,n&&clearTimeout(n)}},[Re,$e,we,Ee,he,pe]);const at=e.useCallback(e=>{Je.current=e},[]),nt=e.useCallback(()=>{var e;null==(e=Je.current)||e.fitView(800)},[]),rt=e.useRef(!1),it=e.useCallback(()=>{var e,t,s,a;if(st(!1),Qe.current||(Qe.current=!0,setTimeout(()=>{var e;null==(e=Je.current)||e.fitView(800)},300)),!rt.current){rt.current=!0;const r=null==(e=Je.current)?void 0:e._internalApi;if(r)try{null==(t=r.initializeLabels)||t.call(r),null==(a=null==(s=r.labels)?void 0:s.update)||a.call(s),setTimeout(()=>{We()},100)}catch(n){}}Q(!1)},[We]),lt=e.useCallback(()=>{const e=Je.current;e&&(X?e.pause():e.start(),Q(!X))},[X]),ot=e.useCallback(async e=>{const t=Je.current;if(t)try{const s=await t.getPointIndicesByIds([e]);s&&s.length>0&&void 0!==s[0]&&t.zoomToPoint(s[0],400,2.5)}catch{}},[]),ct=e.useMemo(()=>{if(!ae.trim())return[];const e=ae.toLowerCase();return Re.filter(t=>{var s;return t.prefix.toLowerCase().includes(e)||(null==(s=t.name)?void 0:s.toLowerCase().includes(e))||t.id.toLowerCase().includes(e)}).slice(0,8)},[Re,ae]),dt=e.useCallback(e=>{ot(e.id),ie(!1),ne(""),te({hash:e.id,name:e.name,prefix:e.prefix,nodeClass:e.nodeClass,packetCount:e.packetCount,edgeCount:Ge.get(e.id)??0,betweenness:e.betweenness,communityId:e.communityId,degree:e.degree,hasGeo:e.hasGeo,isLocal:e.isLocal,isHub:e.isHub,isGateway:e.isGateway,isBackbone:e.isBackbone,isMobile:e.isMobile,isInLoop:e.isInLoop,isZeroHop:e.isZeroHop,avgRssi:e.avgRssi,avgSnr:e.avgSnr,activityLevel:e.activityLevel,prefixConfidence:e.prefixConfidence,hasCollision:e.hasCollision})},[ot,Ge]),ut=e.useRef(void 0),mt=e.useRef(0),xt=e.useCallback(async(e,t,s)=>{const a=Date.now();if(s&&a-mt.current>=16&&(mt.current=a,be.current.x=s.clientX,be.current.y=s.clientY,be.current.node&&window.dispatchEvent(new CustomEvent("meshgraph:hover"))),e===ut.current)return;ut.current=e,ye.current&&(clearTimeout(ye.current),ye.current=null);const n=Je.current;if(n)if(void 0!==e)try{const t=await n.getPointIdsByIndices([e]);if(!t||0===t.length)return;const s=t[0],a=Te.get(s);if(!a)return;be.current.node=a,window.dispatchEvent(new CustomEvent("meshgraph:hover")),n.selectPoint(e,!1,!0)}catch{be.current.node=null,window.dispatchEvent(new CustomEvent("meshgraph:hover"))}else ye.current=setTimeout(()=>{be.current.node=null,window.dispatchEvent(new CustomEvent("meshgraph:hover")),void 0!==se.current?n.selectPoint(se.current,!1,!0):n.unselectAllPoints()},100)},[Te,ee]),ht=e.useCallback(()=>{je(e=>!e)},[]),pt=e.useCallback(async(e,t,s)=>{var a;if(be.current.node=null,window.dispatchEvent(new CustomEvent("meshgraph:hover")),ut.current=void 0,void 0===e)return se.current=void 0,te(null),void(null==(a=Je.current)||a.unselectAllPoints());const n=Je.current;if(n)try{const t=await n.getPointIdsByIndices([e]);if(!t||0===t.length)return;const s=t[0],a=Te.get(s);if(!a)return;se.current=e,n.selectPoint(e,!1,!0),te({hash:s,name:a.name,prefix:a.prefix,nodeClass:a.nodeClass,packetCount:a.packetCount,edgeCount:Ge.get(s)??0,betweenness:a.betweenness,communityId:a.communityId,degree:a.degree,hasGeo:a.hasGeo,isLocal:a.isLocal,isHub:a.isHub,isGateway:a.isGateway,isBackbone:a.isBackbone,isMobile:a.isMobile,isInLoop:a.isInLoop,isZeroHop:a.isZeroHop,avgRssi:a.avgRssi,avgSnr:a.avgSnr,activityLevel:a.activityLevel,prefixConfidence:a.prefixConfidence,hasCollision:a.hasCollision})}catch{}},[Te,Ge]);if(!j)return t.jsxs("div",{className:"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh flex items-center justify-center bg-black",children:[t.jsx(k,{isOpen:D,currentStep:H,packetCount:z}),!D&&t.jsx(L,{className:"w-8 h-8 text-accent-primary animate-spin"})]});if(0===Re.length)return t.jsxs("div",{className:"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh flex flex-col bg-black overflow-hidden",children:[t.jsx("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border-subtle bg-bg-elevated/50",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(x,{className:"w-5 h-5 text-accent-primary"}),t.jsxs("h1",{className:"type-data-sm font-semibold text-text-primary flex items-center gap-2",children:["MeshGraph",t.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wider bg-accent-primary/20 text-accent-primary rounded",children:"Beta"})]})]})}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsx(de,{})})]});if(!_e)return t.jsx("div",{className:"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh flex items-center justify-center bg-black",children:t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx(L,{className:"w-8 h-8 text-accent-primary animate-spin"}),t.jsx("span",{className:"text-sm text-text-muted",children:"Preparing graph..."})]})});const gt=ve?"fixed inset-0 z-50 bg-black":"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh bg-black";return t.jsxs("div",{className:`${gt} flex flex-col overflow-hidden`,children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border-subtle/50 bg-black/80 backdrop-blur-sm z-10",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(x,{className:"w-5 h-5 text-accent-primary"}),t.jsxs("h1",{className:"type-data-sm font-semibold text-text-primary flex items-center gap-2",children:["MeshGraph",t.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wider bg-accent-primary/20 text-accent-primary rounded",children:"Beta"})]}),t.jsxs("span",{className:"type-data-xs text-text-muted tabular-nums",children:[Re.length," nodes • ",$e.length," edges"]}),tt&&t.jsxs("span",{className:"flex items-center gap-1.5 text-[10px] text-accent-primary animate-pulse",children:[t.jsx(L,{className:"w-3 h-3 animate-spin"}),"Stabilizing..."]})]}),t.jsxs("div",{className:"flex items-center gap-0.5",children:[t.jsx(h,{content:"Search nodes (/)",children:t.jsx("button",{onClick:()=>{ie(!0),setTimeout(()=>{var e;return null==(e=le.current)?void 0:e.focus()},50)},className:"p-2 rounded-lg transition-colors "+(re?"bg-accent-primary/20 text-accent-primary":"hover:bg-subtle-fill text-text-muted"),children:t.jsx(F,{className:"w-4 h-4"})})}),t.jsx(h,{content:(X?"Pause":"Resume")+" simulation (Space)",children:t.jsx("button",{onClick:lt,className:"p-2 rounded-lg hover:bg-subtle-fill transition-colors",children:X?t.jsx(p,{className:"w-4 h-4 text-accent-success"}):t.jsx(g,{className:"w-4 h-4 text-text-muted"})})}),t.jsx(h,{content:"Fit view (F)",children:t.jsx("button",{onClick:nt,className:"p-2 rounded-lg hover:bg-subtle-fill transition-colors",children:t.jsx(I,{className:"w-4 h-4 text-text-muted"})})}),t.jsx(h,{content:ve?"Exit fullscreen":"Fullscreen",children:t.jsx("button",{onClick:ht,className:"p-2 rounded-lg hover:bg-subtle-fill transition-colors",children:ve?t.jsx(N,{className:"w-4 h-4 text-text-muted"}):t.jsx(S,{className:"w-4 h-4 text-text-muted"})})})]})]}),t.jsxs("div",{className:"flex-1 relative min-h-0",children:[t.jsx(s,{className:"absolute inset-0",points:_e,links:Ve,...Ke,backgroundColor:"#000000",fitViewOnInit:!1,initialZoomLevel:10,simulationClusterStrength:.8,showLabels:!0,showDynamicLabels:!0,showTopLabels:!0,showTopLabelsLimit:100,showHoveredPointLabel:!0,pointLabelFontSize:11,showClusterLabels:!1,onClick:pt,onMouseMove:xt,onMount:at,onSimulationEnd:it,renderHoveredPointRing:!0,hoveredPointRingColor:"#FBBF24",hoveredPointCursor:"pointer",pointGreyoutOpacity:.2,linkGreyoutOpacity:.15}),t.jsx(f,{children:re&&t.jsx(b.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute top-4 left-1/2 -translate-x-1/2 z-30 w-80",children:t.jsxs("div",{className:"bg-bg-elevated/95 backdrop-blur-sm rounded-xl border border-border-subtle shadow-2xl overflow-hidden",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border-subtle",children:[t.jsx(F,{className:"w-4 h-4 text-text-muted shrink-0"}),t.jsx("input",{ref:le,type:"text",value:ae,onChange:e=>ne(e.target.value),placeholder:"Search by name or prefix...",className:"flex-1 bg-transparent text-sm text-text-primary placeholder:text-text-muted focus:outline-none",onKeyDown:e=>{"Escape"===e.key?(ie(!1),ne("")):"Enter"===e.key&&ct.length>0&&dt(ct[0])}}),ae&&t.jsx("button",{onClick:()=>ne(""),className:"p-0.5 rounded hover:bg-subtle-fill",children:t.jsx(y,{className:"w-3 h-3 text-text-muted"})})]}),ct.length>0&&t.jsx("div",{className:"max-h-64 overflow-y-auto",children:ct.map((e,s)=>{const a=V[e.nodeClass];return t.jsxs("button",{onClick:()=>dt(e),className:"w-full flex items-center gap-3 px-3 py-2 text-left hover:bg-subtle-fill transition-colors "+(0===s?"bg-subtle-fill/50":""),children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-full shrink-0",style:{backgroundColor:_[e.nodeClass]}}),t.jsx(a,{className:"w-3.5 h-3.5 text-text-muted shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm text-text-primary truncate",children:e.name||e.prefix}),e.name&&t.jsx("div",{className:"text-[10px] text-text-muted",children:e.prefix})]}),t.jsx(E,{className:"w-3 h-3 text-text-muted shrink-0"})]},e.id)})}),ae&&0===ct.length&&t.jsx("div",{className:"px-3 py-4 text-center text-sm text-text-muted",children:"No nodes found"}),!ae&&t.jsx("div",{className:"px-3 py-2 text-[10px] text-text-muted",children:"Type to search • Enter to select • Esc to close"})]})})}),t.jsx(U,{nodeCount:Re.length,edgeCount:$e.length}),!ee&&t.jsxs("div",{className:"absolute bottom-4 right-4 z-10 hidden lg:flex items-center gap-3 text-[10px] text-text-muted/60",children:[t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"/"})," Search"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"F"})," Fit"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"Space"})," Pause"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"Esc"})," Clear"]})]}),t.jsx(f,{children:ee&&t.jsx(ce,{node:ee,connections:Ae,onClose:()=>{var e;se.current=void 0,te(null),null==(e=Je.current)||e.unselectAllPoints()}})})]})]})}export{ue as default};
