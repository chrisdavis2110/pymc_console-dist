import{r as e,j as a,aa as s,ab as t,ac as l,C as i,ad as n,ae as r,af as c,ag as o,Z as d,a9 as m,ah as u,ai as p,aj as x,ak as h,E as b,X as g}from"./vendor-react-DWFolw7W.js";import{c as v}from"./recharts-BfwfJFmd.js";import{u as j,c as f,b as y,t as N,v as w,R as k,e as C,L as S,x as _}from"./index-Bqom4285.js";import{d as R,e as L,g as M,b as T,P,a as F,c as A,T as H}from"./TraceReportModal-DyyfjHYo.js";import{P as V,b as D,a as $}from"./PageLayout-Ddo-4Uor.js";import{C as q}from"./Card-G6bVQsoG.js";import"./vendor-core-WoOfkQwm.js";import"./deckgl-DTsmDcfs.js";import"./SignalIndicator-3iePFw_K.js";import"./dialog-BxW5aXUD.js";import"./DataBox-DmFkSY6u.js";import"./useThemeColors-BvpMB3J1.js";function E({options:r,value:c,onChange:o,defaultValue:d,displayValue:m,filter:u,placeholder:p,disabled:x,invalid:h,name:b,"aria-label":g,className:j,children:f}){const[y,N]=e.useState(""),w=m??(e=>null!=e?String(e):""),k=u??((e,a)=>w(e).toLowerCase().includes(a.toLowerCase())),C=e.useMemo(()=>y?r.filter(e=>k(e,y)):r,[r,y,k]);return a.jsx(s,{value:c,onChange:o,defaultValue:d,disabled:x,name:b,onClose:()=>N(""),children:a.jsxs("div",{className:v("relative",j),children:[a.jsxs("div",{className:"relative",children:[a.jsx(t,{"aria-label":g,displayValue:w,onChange:e=>N(e.target.value),placeholder:p,className:v(["w-full rounded-lg py-2 pl-3 pr-10","text-sm text-text-primary placeholder:text-text-muted","bg-bg-subtle border",h?"border-accent-danger":"border-border-subtle","focus:outline-none focus:border-accent-primary/50 focus:ring-1 focus:ring-accent-primary/20","hover:border-border-strong","disabled:opacity-50 disabled:cursor-not-allowed","transition-colors duration-150"])}),a.jsx(l,{className:"absolute inset-y-0 right-0 flex items-center pr-3 group",children:a.jsx(i,{className:"w-4 h-4 text-text-muted transition-transform duration-200 group-data-[open]:rotate-180"})})]}),a.jsx(n,{anchor:"bottom start",transition:!0,className:v(["w-[var(--input-width)] min-w-[180px]","max-h-60 overflow-y-auto overscroll-contain scroll-py-1","rounded-lg p-1 mt-1","glass-card-elevated","focus:outline-none","transition-opacity duration-150 ease-out","data-[closed]:opacity-0","data-[enter]:duration-150 data-[leave]:duration-100","z-50"]),children:0===C.length&&""!==y?a.jsx("div",{className:"px-3 py-2 text-sm text-text-muted",children:"No results found"}):C.map((s,t)=>a.jsx(e.Fragment,{children:f(s)},t))})]})})}function z({value:s,disabled:t,className:l,children:i}){return a.jsx(r,{as:e.Fragment,value:s,disabled:t,children:({selected:e,focus:s})=>a.jsxs("div",{className:v("flex items-center gap-2 px-3 py-2 rounded-md cursor-default","text-sm",s&&"bg-accent-primary text-white",!s&&"text-text-primary",e&&!s&&"text-accent-primary",t&&"opacity-50 cursor-not-allowed",l),children:[a.jsx("span",{className:"w-4 flex-shrink-0",children:e&&a.jsx(c,{className:"w-4 h-4"})}),a.jsx("span",{className:"truncate flex-1",children:i})]})})}function B({className:e,...s}){return a.jsx("span",{...s,className:v("truncate",e)})}function O({value:e,onChange:s,options:t,placeholder:l,disabled:i,className:n,"aria-label":r}){const c=t.find(a=>a.value===e);return a.jsx(E,{options:t,value:c,onChange:e=>{e&&s(e.value)},displayValue:e=>(null==e?void 0:e.label)??"",filter:(e,a)=>e.label.toLowerCase().includes(a.toLowerCase()),placeholder:l,disabled:i,className:n,"aria-label":r,children:e=>a.jsx(z,{value:e,disabled:e.disabled,children:a.jsx(B,{children:e.label})})})}function G({icon:e,label:s,value:t,color:l,percentage:i}){return a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:v("p-1.5 rounded-md",l),children:e}),a.jsxs("div",{className:"flex flex-col",children:[a.jsx("span",{className:"text-sm font-semibold text-text-primary",children:t.toLocaleString()}),a.jsxs("span",{className:"text-[10px] text-text-muted leading-tight",children:[s,void 0!==i&&a.jsxs("span",{className:"ml-1 opacity-70",children:["(",i,"%)"]})]})]})]})}const I=e.memo(function({packets:s}){const t=e.useMemo(()=>{let e=0,a=0,t=0;const l=new Set;let i=0,n=0;for(const o of s){switch(R(o)){case"forward":e++;break;case"dropped":a++;break;case"duplicate":t++}o.src_hash&&l.add(o.src_hash),o.rssi&&(i+=o.rssi,n++)}const r=s.length,c=n>0?Math.round(i/n):0;return{total:r,rx:r,fwd:e,dropped:a,duplicate:t,uniqueSources:l.size,avgRssi:c,rxPercent:100,fwdPercent:r>0?Math.round(e/r*100):0,droppedPercent:r>0?Math.round(a/r*100):0}},[s]);return 0===s.length?null:a.jsx("div",{className:"glass-card p-3 pr-4",children:a.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:flex sm:items-center sm:justify-between sm:gap-6",children:[a.jsx(G,{icon:a.jsx(o,{className:"w-3.5 h-3.5 text-accent-primary"}),label:"Received",value:t.rx,color:"bg-accent-primary/10",percentage:t.rxPercent}),a.jsx(G,{icon:a.jsx(d,{className:"w-3.5 h-3.5 text-accent-success"}),label:"Forwarded",value:t.fwd,color:"bg-accent-success/10",percentage:t.fwdPercent}),a.jsx(G,{icon:a.jsx(m,{className:"w-3.5 h-3.5 text-accent-danger"}),label:"Dropped",value:t.dropped,color:"bg-accent-danger/10",percentage:t.droppedPercent}),a.jsx(G,{icon:a.jsx(u,{className:"w-3.5 h-3.5 text-text-muted"}),label:"Duplicates",value:t.duplicate,color:"bg-white/5"}),a.jsxs("div",{className:"hidden sm:flex items-center gap-6 ml-auto",children:[a.jsx(G,{icon:a.jsx(p,{className:"w-3.5 h-3.5 text-accent-secondary"}),label:"Sources",value:t.uniqueSources,color:"bg-accent-secondary/10"}),a.jsxs("div",{className:"flex flex-col items-end pr-1",children:[a.jsxs("span",{className:"text-sm font-mono text-text-secondary",children:[t.avgRssi," dBm"]}),a.jsx("span",{className:"text-[10px] text-text-muted",children:"Avg Signal"})]})]})]})})});function W(){const s=j(),t=f(),l=y(),i=N(),n=null==t?void 0:t.local_hash,r=null==t?void 0:t.neighbors,[c,o]=e.useState(null),[d,m]=e.useState(null),[u,p]=e.useState(!1),[E,z]=e.useState({limit:100,status:"all"}),[B,G]=e.useState(null),[W,Z]=e.useState(null),[J,K]=e.useState(Date.now);e.useEffect(()=>{E.timeRange&&E.timeRange>0&&queueMicrotask(()=>K(Date.now()))},[E.timeRange,s]);const Q=e.useMemo(()=>{const e=E.limit??100;return[...s.length<=e?s:s.slice(-e)].sort((e,a)=>(a.timestamp??0)-(e.timestamp??0))},[s,E.limit]),U=0===s.length,X=e.useMemo(()=>{let e=Q;if(void 0!==E.type){const a=w[E.type];e=e.filter(e=>{const s=e.type??e.payload_type,t=e.payload_type_name;return s===E.type||t===a})}if(void 0!==E.route){const a=k[E.route];e=e.filter(e=>{const s=e.route??e.route_type,t=e.route_type_name;return s===E.route||t===a})}if(E.status&&"all"!==E.status&&(e=e.filter(e=>R(e)===E.status)),void 0!==E.signalMin&&(e=e.filter(e=>e.rssi>=E.signalMin)),E.timeRange&&E.timeRange>0){const a=J/1e3-3600*E.timeRange;e=e.filter(e=>e.timestamp>=a)}return e},[Q,E.type,E.route,E.status,E.signalMin,E.timeRange,J]),Y=(e,a)=>z(s=>({...s,[e]:a})),ee=void 0!==E.type||void 0!==E.route||E.status&&"all"!==E.status||void 0!==E.signalMin||E.timeRange&&E.timeRange>0,ae=e.useMemo(()=>{const e=new Map;for(const a of X)if((a.payload_type??a.type)===C.TRACE&&a.payload){const s=L(a.payload);s&&a.packet_hash&&e.set(a.packet_hash,s)}return e},[X]),se=e.useCallback(e=>{const a=s.filter(a=>!((a.payload_type??a.type)!==C.TRACE||!a.payload)&&L(a.payload)===e);if(a.length>0){const s=M(a).get(e);if(s&&s.length>0){const a=T(e,s);Z(a)}}},[s]);return a.jsxs(V,{children:[a.jsx(D,{title:"Packet History",icon:a.jsx(b,{}),controls:a.jsxs(a.Fragment,{children:[l&&a.jsx(S,{showLabel:!0}),a.jsxs(_,{outline:!0,color:ee?"primary":"muted",onClick:()=>p(!u),className:"sm:hidden",children:[a.jsx(x,{"data-slot":"icon"}),ee&&a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-accent-primary"})]}),a.jsxs(_,{outline:!0,color:l?"success":"muted",onClick:()=>i(!l),children:[a.jsx(h,{"data-slot":"icon",className:v(l&&"animate-spin")}),a.jsx("span",{className:"hidden xs:inline",children:l?"Live":"Paused"})]})]})}),a.jsxs($,{noPadding:!0,className:v("overflow-hidden transition-all duration-200",u?"max-h-96 opacity-100":"max-h-0 opacity-0 sm:max-h-96 sm:opacity-100"),children:[a.jsx(q,{listHeader:!0,icon:a.jsx(x,{className:"icon-sm"}),title:"Filters",actions:ee?a.jsxs(_,{plain:!0,color:"muted",onClick:()=>z({limit:E.limit,status:"all"}),className:"!text-xs !py-0.5 !px-1.5",children:[a.jsx(g,{"data-slot":"icon",className:"!w-3 !h-3"}),"Clear"]}):void 0}),a.jsx("div",{className:"p-3 sm:p-4",children:a.jsxs("div",{className:"grid grid-cols-2 sm:flex sm:flex-wrap gap-3",children:[a.jsxs("div",{className:"flex-1 min-w-[140px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Type"}),a.jsx(O,{value:E.type??"",onChange:e=>Y("type",""===e?void 0:Number(e)),options:[{value:"",label:"All Types"},...Object.entries(w).map(([e,a])=>({value:Number(e),label:a}))],placeholder:"Search types...","aria-label":"Filter by packet type"})]}),a.jsxs("div",{className:"flex-1 min-w-[140px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Route"}),a.jsx(O,{value:E.route??"",onChange:e=>Y("route",""===e?void 0:Number(e)),options:[{value:"",label:"All Routes"},...Object.entries(k).map(([e,a])=>({value:Number(e),label:a}))],placeholder:"Search routes...","aria-label":"Filter by route type"})]}),a.jsxs("div",{className:"flex-1 min-w-[140px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Status"}),a.jsx(O,{value:E.status??"all",onChange:e=>Y("status",e),options:[{value:"all",label:"All Status"},{value:"rx",label:"Received"},{value:"forward",label:"Forwarded"},{value:"dropped",label:"Dropped"},{value:"duplicate",label:"Duplicate"}],placeholder:"Search status...","aria-label":"Filter by status"})]}),a.jsxs("div",{className:"flex-1 min-w-[120px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Time"}),a.jsx(O,{value:E.timeRange??0,onChange:e=>Y("timeRange",0===e?void 0:e),options:[{value:0,label:"All Time"},{value:1,label:"Last 1h"},{value:6,label:"Last 6h"},{value:24,label:"Last 24h"},{value:168,label:"Last 7d"}],placeholder:"Search time...","aria-label":"Filter by time range"})]}),a.jsxs("div",{className:"flex-1 min-w-[130px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Signal"}),a.jsx(O,{value:E.signalMin??"",onChange:e=>Y("signalMin",""===e?void 0:Number(e)),options:[{value:"",label:"Any Signal"},{value:-90,label:"Strong (≥-90)"},{value:-100,label:"Good (≥-100)"},{value:-110,label:"Fair (≥-110)"},{value:-120,label:"Weak (≥-120)"}],placeholder:"Search signal...","aria-label":"Filter by signal strength"})]}),a.jsxs("div",{className:"flex-1 min-w-[100px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Limit"}),a.jsx(O,{value:E.limit??100,onChange:e=>Y("limit",e),options:[{value:50,label:"50"},{value:100,label:"100"},{value:200,label:"200"},{value:500,label:"500"}],placeholder:"Limit...","aria-label":"Packet limit"})]})]})})]}),a.jsx(I,{packets:X}),a.jsxs($,{noPadding:!0,className:"!overflow-visible",children:[a.jsx("div",{className:"hidden sm:block divide-y divide-white/5 py-1",children:U&&0===Q.length?a.jsx("div",{className:"py-14 text-center text-sm text-text-muted",children:"Loading packets..."}):0===X.length?a.jsx("div",{className:"py-14 text-center text-sm text-text-muted",children:"No packets found"}):X.map((e,s)=>{const t=e.packet_hash?ae.get(e.packet_hash):void 0,l=null!==B&&t===B;return a.jsx(P,{packet:e,onClick:e=>{m(e.packet_hash??null),o(e)},localHash:n,neighbors:r,traceTag:t,isTraceHighlighted:l,onTraceHover:G,onViewTraceReport:se,isSelected:e.packet_hash===d},`${e.packet_hash}_${e.timestamp}_${s}`)})}),a.jsx("div",{className:"sm:hidden divide-y divide-white/5",children:U&&0===Q.length?a.jsx("div",{className:"py-12 text-center text-sm text-text-muted",children:"Loading packets..."}):0===X.length?a.jsx("div",{className:"py-12 text-center text-sm text-text-muted",children:"No packets found"}):X.map((e,s)=>{const t=e.packet_hash?ae.get(e.packet_hash):void 0,l=null!==B&&t===B;return a.jsx(F,{packet:e,onClick:e=>{m(e.packet_hash??null),o(e)},localHash:n,neighbors:r,traceTag:t,isTraceHighlighted:l,onTraceHover:G,onViewTraceReport:se,isSelected:e.packet_hash===d},`${e.packet_hash}_${e.timestamp}_${s}`)})}),a.jsxs("div",{className:"px-4 py-3 border-t border-white/5 text-xs text-text-muted sm:px-6",children:["Showing ",a.jsx("span",{className:"font-medium text-text-secondary",children:X.length})," of"," ",a.jsx("span",{className:"font-medium text-text-secondary",children:Q.length})," packets"]})]}),c&&a.jsx(A,{packet:c,onClose:()=>o(null)}),W&&a.jsx(H,{report:W,onClose:()=>Z(null),onViewPacket:e=>{const a=s.find(a=>a.packet_hash===e);a&&(Z(null),o(a))}})]})}export{W as default};
